<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard – Prospectos & Llamados</title>
  <link rel="icon" href="logo.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{--bg:#0f1420;--fg:#e9eef7;--muted:#b8c2d9;--card:#151c2c;--line:#23314d;--accent:#4da3ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--line);position:sticky;top:0;background:linear-gradient(0deg,rgba(15,20,32,.85),rgba(15,20,32,.85));backdrop-filter: blur(8px)}
    header img{height:28px}
    h1{font-size:18px;margin:0}
    .wrap{padding:20px;max-width:1300px;margin:auto}
    .grid{display:grid;gap:16px}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:1100px){.grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:700px){.grid.cols-4,.grid.cols-2{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:28px;font-weight:700}
    .kpi .sub{color:var(--muted);font-size:12px}
    .card h3{margin:0 0 8px;font-size:14px;color:var(--muted);font-weight:600;letter-spacing:.2px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
    th{color:var(--muted);font-weight:600;font-size:12px}
    tr:hover td{background:#121a2b}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    input[type="text"],select{background:#0e1524;border:1px solid var(--line);color:var(--fg);padding:8px 10px;border-radius:10px}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    a.link{color:var(--accent);text-decoration:none}
    .footer{margin:24px 0;color:var(--muted);font-size:12px}
    .notice{background:#0e1524;border:1px dashed #2a3b5f;border-radius:12px;padding:10px 12px;color:#a9b7d0}
    /* Límite duro para que el canvas no haga crecer el card */
    #chartEstados, #chartOperador, #chartCompanias { max-height: 320px; } /* podés subir a 360 si querés */
    /* Para que no se corten los labels largos en el eje Y */
    canvas { image-rendering: auto; }
  </style>
</head>
<body>
  <header>
    <img id="logo" src="logo.png" alt="Logo" />
    <h1>Dashboard – Prospectos & Llamados</h1>
    <span class="pill" id="dataStatus" style="margin-left:auto">Cargando…</span>
  </header>
  <div class="wrap">

    <div class="card notice" id="configNotice" style="display:none">
      <strong>Config faltante:</strong> pegá las URLs CSV de tus hojas de Google Sheets en el bloque <code>CONFIG</code> del script.
    </div>

    <!-- KPIs -->
    <section class="grid cols-4" style="margin-bottom:16px">
      <div class="card kpi"><div class="label">Prospectos totales</div><div class="value" id="kpiPros">–</div><div class="sub" id="kpiProsSub"> </div></div>
      <div class="card kpi"><div class="label">Llamados (30 días)</div><div class="value" id="kpiLlam30">–</div><div class="sub" id="kpiLlam30Sub"> </div></div>
      <div class="card kpi"><div class="label">Nuevos prospectos (30 días)</div><div class="value" id="kpiPros30">–</div><div class="sub">vs total</div></div>
      <div class="card kpi"><div class="label">Última actualización</div><div class="value" id="kpiUpdated">–</div><div class="sub" id="kpiUpdatedSub"> </div></div>
    </section>

    <!-- Charts -->
    <section class="grid cols-2" style="margin-bottom:16px">
      <div class="card">
        <h3>Top Etiquetas</h3>
        <canvas id="chartEstados"></canvas>
      </div>
      <div class="card">
        <h3>Llamados por Operador (últimos 30 días)</h3>
        <canvas id="chartOperador"></canvas>
      </div>
      <!-- 3ª tarjeta: quedará debajo de “Top Etiquetas” -->
      <div class="card">
        <h3>Top Compañías</h3>
        <canvas id="chartCompanias"></canvas>
      </div>
    </section>

    <!-- Tables -->
    <section class="grid cols-2">
      <div class="card">
        <div class="toolbar">
          <h3 style="margin-right:auto">Prospectos recientes</h3>
          <input id="searchPros" type="text" placeholder="Buscar… (Compañía, Contacto, Estado)" />
        </div>
        <table>
          <thead>
            <tr>
              <th>FechaAlta</th><th>Compañía</th><th>Contacto</th><th>Estado</th><th>Origen</th>
            </tr>
          </thead>
          <tbody id="tbodyPros"></tbody>
        </table>
      </div>
      <div class="card">
        <div class="toolbar">
          <h3 style="margin-right:auto">Llamados recientes</h3>
          <input id="searchLlam" type="text" placeholder="Buscar… (Operador, Resultado, ProspectoID)" />
        </div>
        <table>
          <thead>
            <tr>
              <th>Fecha</th><th>ProspectoID</th><th>Operador</th><th>Resultado</th>
            </tr>
          </thead>
          <tbody id="tbodyLlam"></tbody>
        </table>
      </div>
    </section>

    <div class="footer">Hecho con ❤️ y <a class="link" href="https://www.chartjs.org/" target="_blank" rel="noreferrer">Chart.js</a> · Datos desde Google  publicado como CSV.</div>
  </div>

<script>
/*************************
 * CONFIG – Editá acá
 *************************/
const CONFIG = {
  LOGO_URL: 'logo.png',

  CSV_PROSPECTOS_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR11IHFM7jVM_QT1iTEzGEAyhRIBWhI_X6s1XWxW7ZILxMOK09jKQ0356inkeevTTp-L4ukSoFn2wjK/pub?gid=375626003&single=true&output=csv',
  CSV_LLAMADOS_URL  : 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR11IHFM7jVM_QT1iTEzGEAyhRIBWhI_X6s1XWxW7ZILxMOK09jKQ0356inkeevTTp-L4ukSoFn2wjK/pub?gid=1112671308&single=true&output=csv',

  // ⇩ estos nombres deben coincidir EXACTO con los headers del CSV
  COLS_PROS: {
    id: 'ID',
    fechaAlta: 'Creado',        // mm/dd/yyyy hh:mm
    compania: 'Compañias',
    contacto: 'Responsable',
    tel: 'Tel',
    email: 'Email',
    origen: 'Origen',
    estado: 'Etiquetas'
  },
  COLS_LLAM: {
    id: 'LlamadoID',
    prospectoId: 'ProspectoID',
    fecha: 'Fecha de la llamada', // si tu hoja usa 'Fecha', cambiá acá a 'Fecha'
    operador: 'Empleado',
    resultado: 'Estatus',
    notas: 'Notas',
    Duracion: 'Duración de la llamada'
  }
};


/*************************
 * Utilidades
 *************************/
const $ = sel => document.querySelector(sel);
const fmt = n => n.toLocaleString('es-AR');

// Parser de fechas flexible.
// Soporta yyyy-mm-dd, dd/mm/yyyy, mm/dd/yyyy, con hora opcional.
// `prefer` define qué asumir cuando ambos números <= 12: 'dmy' o 'mdy'.
function parseDateFlex(v, prefer = 'mdy'){
  if (!v) return null;
  const s = String(v).trim();

  // ISO: 2025-10-31 23:08 o 2025/10/31
  let m = s.match(/^(\d{4})[/-](\d{2})[/-](\d{2})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if (m) return new Date(+m[1], +m[2]-1, +m[3], +(m[4]||0), +(m[5]||0), +(m[6]||0));

  // Barras: dd/mm/yyyy o mm/dd/yyyy (+hora opcional)
  m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if (m) {
    let a = +m[1], b = +m[2]; // a/b = día/mes o mes/día
    let day, month;
    if (a > 12 && b <= 12)      { day = a; month = b; }       // 31/10 -> dd/mm
    else if (b > 12 && a <= 12) { month = a; day = b; }       // 10/31 -> mm/dd
    else if (prefer === 'dmy')  { day = a; month = b; }       // ambiguo -> dmy
    else                        { month = a; day = b; }       // ambiguo -> mdy (default)
    return new Date(+m[3], month-1, day, +(m[4]||0), +(m[5]||0), +(m[6]||0));
  }

  const d = new Date(s);
  return isNaN(d) ? null : d;
};

const daysAgo = (d, n) => {
  if (!(d instanceof Date)) return false;
  const cut = new Date();
  cut.setHours(0,0,0,0);
  cut.setDate(cut.getDate() - n);
  return d >= cut;
};

const groupCount = (arr, key)=> arr.reduce((acc, it)=>{
  const k = (typeof key === 'function') ? key(it) : (it[key] ?? 'Sin dato');
  acc[k] = (acc[k]||0) + 1;
  return acc;
}, {});

function ensureConfig(){
  let ok = true;
  if(!CONFIG.CSV_PROSPECTOS_URL || CONFIG.CSV_PROSPECTOS_URL.startsWith('REEMPLAZA')) ok=false;
  if(!CONFIG.CSV_LLAMADOS_URL || CONFIG.CSV_LLAMADOS_URL.startsWith('REEMPLAZA')) ok=false;
  if(!ok) $('#configNotice').style.display='block';
  $('#logo').src = CONFIG.LOGO_URL || 'logo.png';
}

function papaCsv(url){
  return new Promise((resolve, reject)=>{
    Papa.parse(url, {download:true, header:true, skipEmptyLines:true,
      complete: (res)=> resolve(res.data),
      error: reject
    });
  });
}


/*************************
 * Render
 *************************/
let PROS=[], LLAM=[];

function renderKPIs(){
  const c  = CONFIG.COLS_PROS;
  const cl = CONFIG.COLS_LLAM;

  const totalPros = PROS.length;

  // Pros (mm/dd) → prefer 'mdy'
  const nuevos30 = PROS.filter(p=>{
    const d = parseDateFlex(p[c.fechaAlta], 'mdy');
    return d && daysAgo(d,30);
  }).length;

  // Llamados (dd/mm) → prefer 'dmy'
  const llam30 = LLAM.filter(l=>{
    const d = parseDateFlex(l[cl.fecha], 'dmy');
    return d && daysAgo(d,30);
  }).length;

  // KPIs
  $('#kpiPros').textContent = fmt(totalPros);
  $('#kpiProsSub').textContent = `${fmt(nuevos30)} nuevos (30d)`;
  $('#kpiLlam30').textContent = fmt(llam30);
  $('#kpiLlam30Sub').textContent = `${fmt(LLAM.length)} total histórico`;
  $('#kpiPros30').textContent = fmt(nuevos30);

  // Última actualización = max(fechaPros, fechaLlam)
  const maxFechaPros = PROS
    .map(p=>parseDateFlex(p[c.fechaAlta], 'mdy'))
    .filter(Boolean).sort((a,b)=>b-a)[0];

  const maxFechaLlam = LLAM
    .map(l=>parseDateFlex(l[cl.fecha], 'dmy'))
    .filter(Boolean).sort((a,b)=>b-a)[0];

  const last = [maxFechaPros,maxFechaLlam].filter(Boolean).sort((a,b)=>b-a)[0];
  if(last){
    $('#kpiUpdated').textContent = last.toLocaleDateString('es-AR');
    const diff = Math.round((new Date()-last)/86400000);
    $('#kpiUpdatedSub').textContent =
      diff===0 ? 'hoy' : (diff===1 ? 'hace 1 día' : `hace ${diff} días`);
  }
}

let chartEstados, chartOperador, chartCompanias;

function renderCharts(){
  const c  = CONFIG.COLS_PROS, cl = CONFIG.COLS_LLAM;

  // --- Prospectos por etiqueta (Top 10) ---
  const estados   = groupCount(PROS, p => p[c.estado] || 'Sin estado');
  const entriesE  = Object.entries(estados).sort((a,b)=> b[1]-a[1]).slice(0,10);
  const labelsE   = entriesE.map(([k]) => k);
  const dataE     = entriesE.map(([,v]) => v);

  // --- Llamados por operador (últimos 30 días) ---
  const llam30    = LLAM.filter(l => {
    const d = parseDateFlex(l[cl.fecha], 'dmy'); // tu hoja usa dd/mm
    return d && daysAgo(d,30);
  });
  const porOper   = groupCount(llam30, l => l[cl.operador] || 'Sin operador');
  const entriesO  = Object.entries(porOper).sort((a,b)=> b[1]-a[1]);
  const labelsO   = entriesO.map(([k]) => k);
  const dataO     = entriesO.map(([,v]) => v);

  // --- Compañías (Top 10) ---
  const companias = groupCount(PROS, p => p[c.compania] || 'Sin compañía');
  const entriesC  = Object.entries(companias).sort((a,b)=> b[1]-a[1]).slice(0,10);
  const labelsC   = entriesC.map(([k]) => k);
  const dataC     = entriesC.map(([,v]) => v);

  // Altura dinámica limitada (misma lógica para los 3)
  const H = (n) => {
    if (!n) return 160;
    if (n <= 6) return 220;
    return Math.min(320, 22 * n + 80);
  };

  // Canvases
  const elE = document.getElementById('chartEstados');
  const elO = document.getElementById('chartOperador');
  const elC = document.getElementById('chartCompanias');

  // Ajuste de altura
  elE.style.height = H(labelsE.length) + 'px';
  elO.style.height = H(labelsO.length) + 'px';
  elC.style.height = H(labelsC.length) + 'px';

  // Contextos
  const ctxE = elE.getContext('2d');
  const ctxO = elO.getContext('2d');
  const ctxC = elC.getContext('2d');

  // Destruir instancias previas
  if (chartEstados)    chartEstados.destroy();
  if (chartOperador)   chartOperador.destroy();
  if (chartCompanias)  chartCompanias.destroy();

  // Opciones comunes
  const commonOpts = (labels)=>({
    indexAxis: 'y',
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    layout: { padding: { right: 28 } },
    plugins: { legend: { display:false }, tooltip: { mode:'nearest', intersect:false } },
    scales: {
      x: { beginAtZero:true, ticks:{ precision:0 }, grid:{ color:'rgba(255,255,255,.06)' } },
      y: {
        ticks: { autoSkip:false, font:{ size:12 }, callback: (v,i)=> shortenLabel(labels[i], 36) },
        grid: { display:false }
      }
    }
  });

  // Prospectos por etiqueta
  chartEstados = new Chart(ctxE, {
    type: 'bar',
    data: {
      labels: labelsE,
      datasets: [{
        label: 'Prospectos',
        data: dataE,
        barThickness: 18,
        maxBarThickness: 22,
        borderRadius: 6,
        borderSkipped: false,
        categoryPercentage: 0.6,
        barPercentage: 0.9
      }]
    },
    options: commonOpts(labelsE),
    plugins: [valueLabels]
  });

  // Llamados por operador
  chartOperador = new Chart(ctxO, {
    type: 'bar',
    data: {
      labels: labelsO,
      datasets: [{
        label: 'Llamados (30d)',
        data: dataO,
        barThickness: 18,
        maxBarThickness: 22,
        borderRadius: 6,
        borderSkipped: false,
        categoryPercentage: 0.6,
        barPercentage: 0.9
      }]
    },
    options: commonOpts(labelsO),
    plugins: [valueLabels]
  });

  // Top Compañías (nuevo)
  chartCompanias = new Chart(ctxC, {
    type: 'bar',
    data: {
      labels: labelsC,
      datasets: [{
        label: 'Prospectos',
        data: dataC,
        barThickness: 18,
        maxBarThickness: 22,
        borderRadius: 6,
        borderSkipped: false,
        categoryPercentage: 0.6,
        barPercentage: 0.9
      }]
    },
    options: commonOpts(labelsC),
    plugins: [valueLabels]
  });
}

function renderTables(){
  const c = CONFIG.COLS_PROS, cl = CONFIG.COLS_LLAM;
  const tbodyP = $('#tbodyPros');
  const tbodyL = $('#tbodyLlam');

  // Orden por fecha correcta
  const prosOrd = [...PROS].sort((a,b)=>
    (parseDateFlex(b[c.fechaAlta], 'mdy')||0)-(parseDateFlex(a[c.fechaAlta], 'mdy')||0)
  );
  const llamOrd = [...LLAM].sort((a,b)=>
    (parseDateFlex(b[cl.fecha], 'dmy')||0)-(parseDateFlex(a[cl.fecha], 'dmy')||0)
  );

  function rowP(p){
    return `<tr><td>${p[c.fechaAlta]||''}</td><td>${p[c.compania]||''}</td><td>${p[c.contacto]||''}</td><td>${p[c.estado]||''}</td><td>${p[c.origen]||''}</td></tr>`;
  }
  function rowL(l){
    return `<tr><td>${l[cl.fecha]||''}</td><td>${l[cl.prospectoId]||''}</td><td>${l[cl.operador]||''}</td><td>${l[cl.resultado]||''}</td></tr>`;
  }

  const MAX=50;
  tbodyP.innerHTML = prosOrd.slice(0,MAX).map(rowP).join('');
  tbodyL.innerHTML = llamOrd.slice(0,MAX).map(rowL).join('');

  // Búsquedas
  $('#searchPros').oninput = (e)=>{
    const q = e.target.value.toLowerCase();
    tbodyP.innerHTML = prosOrd.filter(p=>[
      p[c.compania], p[c.contacto], p[c.estado], p[c.origen]
    ].some(x=> (x||'').toLowerCase().includes(q))).slice(0,MAX).map(rowP).join('');
  };
  $('#searchLlam').oninput = (e)=>{
    const q = e.target.value.toLowerCase();
    tbodyL.innerHTML = llamOrd.filter(l=>[
      l[cl.operador], l[cl.resultado], l[cl.prospectoId]
    ].some(x=> (x||'').toLowerCase().includes(q))).slice(0,MAX).map(rowL).join('');
  };
}

// Acorta etiquetas largas sin romper palabras (para el eje Y)
function shortenLabel(s, max = 36){
  s = String(s || '');
  if (s.length <= max) return s;
  const cut = s.lastIndexOf(' ', max - 1);
  return (cut > 15 ? s.slice(0, cut) : s.slice(0, max - 1)) + '…';
}

// Plugin para dibujar el valor al final de cada barra
const valueLabels = {
  id: 'valueLabels',
  afterDatasetsDraw(chart){
    const {ctx} = chart;
    const ds = chart.data.datasets[0];
    ctx.save();
    ctx.fillStyle = getComputedStyle(document.body).color;
    ctx.font = '12px system-ui, Segoe UI, Roboto, Arial';
    chart.getDatasetMeta(0).data.forEach((bar, i) => {
      const val = ds.data[i];
      if (val == null) return;
      ctx.fillText(val.toLocaleString('es-AR'), bar.x + 6, bar.y + 4);
    });
    ctx.restore();
  }
};


/*************************
 * Init
 *************************/
async function init(){
  ensureConfig();
  $('#dataStatus').textContent = 'Cargando…';
  try{
    const [pros, llam] = await Promise.all([
      papaCsv(CONFIG.CSV_PROSPECTOS_URL),
      papaCsv(CONFIG.CSV_LLAMADOS_URL)
    ]);
    PROS = pros; LLAM = llam;
    renderKPIs();
    renderCharts();
    renderTables();
    $('#dataStatus').textContent = 'Datos OK';
  }catch(err){
    console.error(err);
    $('#dataStatus').textContent = 'Error de datos';
  }
}

init();
</script>
</body>
</html>
